# Description of oAuth2 login flow.

Login.bib.dk implements the "Authorization Code Grant" as specified in https://tools.ietf.org/html/rfc6749#section-4.1. This documents how to use this implementation-

## Login flow

### 1. Make redirect to https://oauth.login.bib.dk/oauth/authorize

**Authorization Request**

See https://tools.ietf.org/html/rfc6749#section-4.1.1

The client constructs the request URI by adding the following parameters to the query component of the authorization endpoint URI:

- response_type: MUST be set to `code` Indicates that the client expects to receive an authorization code.
- client_id: client ID (Hardcoded to hejmdal)
- redirect_uri - URI to be returned to when user authorization has been completed. Must be configured in the access platform
- scope - is not implementet. If specified it is just discarded.
- state - A hash generated by the client application, so the application can verify the validity of the return call (state is so optional).

`https://oauth.login.bib.dk/oauth/authorize?response_type=code&clientId={CLIENT_ID}​​&redirection_uri={REDIRECTION_URI}&state={SOME_STATE_HASH}`

**Authorization response**

see https://tools.ietf.org/html/rfc6749#section-4.1.2

If login goes well, a redirect will be returned to the defined {REDIRECT_URI} with the following parameters:

- code: The authorization code generated by login.bib.dk. The authorization code expires after 5 minutes, and is a one time token.
- state: If the "state" parameter was present in the client authorization request, the exact value is returned to the client.

`{REDIRECTION_URI}/?state={SOME_STATE_HASH}&code={AUTHORIZATION_CODE}`

An authorization_code indicates that a user has logged in with the access platform. An authorization_code is a one-time code that can be used to retrieve an access token. This is done in cold 2.

### 2. Access Token Request.

**request:**

See https://tools.ietf.org/html/rfc6749#section-4.1.3

The client makes a request to the token endpoint by sending the, following parameters using the "application/x-www-form-urlencoded" format to `https://oauth.login.bib.dk/oauth/token`

- code: authorization code that was returned from previous call to `oauth/authorize`.
- redirect_uri: Must be the same redirect_uri, which is used to retrieve authorization code.
- client_id: client ID (In the mock implementation, it is hardcoded to hejmdal).
- client_secret: client secret (In the mock implementation, it is hardcoded to "hejmdal_secret").

`curl -X POST https://oauth.login.bib.dk/oauth/token -d 'grant_type=authorization_code&code={AUTH_CODE}&client_id={CLIENT_ID}&client_secret={CLIENT_SECRET}&redirect_uri=REDIRECT_URI}'`

**response**

See https://tools.ietf.org/html/rfc6749#section-4.1.4

`{"access_token": "RsT5OjbzRn430zqMLgV3Ia", "expires_in": 3600`

### 3. User info request http://oauth.login.bib.dk/userinfo

The client makes a request to the token endpoint by sending the, following parameters using the "application/x-www-form-urlencoded" format to `https://oauth.login.bib.dk/userinfo`

- access_code: access_token retrieved from through `oauth/token`.

`curl https://oauth.login.bib.dk/userinfo -H 'Authorization:: Bearer {ACCESS_TOKEN}'`

response:

Returns a map of attributes. Which attributes that a returned depends on the client configuration. The default configuration returns uniqueId and municipality

```
{
  "attributes": {
    "userId": "0101701234",
    "uniqueId": "9ea16d6a9e2cbec5215fa4c35cfc3ea231a3481ffce5f75e998029527d3ec1e0",
    "agencies": [
      {
        "agencyId": "710100",
        "userId": "0101701234",
        "userIdType": "CPR"
      },
      {
        "agencyId": "714700",
        "userId": "12345678",
        "userIdType": "LOCAL"
      }
    ]
  }
}
```

### possible user attributes

- `cpr`: `CPR-number`
  E.g. 010203791234
- `libraries` : `List of libraries a user is registered on`
  ```[
        {
          "agencyId": "710100",
          "userId": "0101701234",
          "userIdType": "CPR"
        },
        {
          "agencyId": "714700",
          "userId": "12345678",
          "userIdType": "LOCAL"
        }
      ]
  ```
- `municipality` : `Muncipality number (see http://www.linking.dk/lokalportaler/kommuner.html)`
- `userId` : 'User ID used at login, normally it corresponds with CPR, but this is not garantied'
- `uniqueId` : `Anonymous user ID`

As default only municipality and uniqueId is returned. If any other attributes is required, it needs to be configurated in the client.

## Log out

To log out of the access platform, redirect to `https://oauth.login.bib.dk/logout/?access_token={ACCESS_TOKEN}`
